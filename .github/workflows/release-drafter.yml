name: Release Drafter

on:
  push:
    branches:
      - main
  pull_request_target:
    branches:
      - main
    types: [opened, reopened, synchronize, labeled, unlabeled, edited]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  RELEASE_DRAFTER_COMMIT: b1476f6e6eb133afa41ed8589daba6dc69b4d3f5 # v6.1.0

jobs:
  update_release_draft:
    runs-on: ubuntu-latest
    concurrency:
      group: release-drafter-${{ github.ref }}
      cancel-in-progress: false
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Validate Release Drafter reference
        run: |
          set -euo pipefail
          ref_url="https://api.github.com/repos/release-drafter/release-drafter/git/commits/${RELEASE_DRAFTER_COMMIT}"
          curl_opts=(
            --fail
            --silent
            --show-error
            --location
            --retry 5
            --retry-delay 2
            --retry-max-time 30
            --connect-timeout 5
          )
          if ! curl "${curl_opts[@]}" \
            -H 'Accept: application/vnd.github.v3+json' \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H 'X-GitHub-Api-Version: 2022-11-28' \
            "$ref_url" >/dev/null; then
            echo "Failed to resolve Release Drafter commit ${RELEASE_DRAFTER_COMMIT}." >&2
            echo "Ensure the workflow pins a valid Release Drafter ref before re-running." >&2
            exit 1
          fi
      - name: Update release draft
        # Pin to the latest v6 release (v6.1.0). Release Drafter does not publish a v7 tag yet.
        uses: release-drafter/release-drafter@b1476f6e6eb133afa41ed8589daba6dc69b4d3f5
        with:
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

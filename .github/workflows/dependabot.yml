---
name: Dependabot Auto Merge

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    # Run this job only for Dependabot PRs.
    if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dependabot metadata
        id: metadata
        # v2.4.0
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Auto approve
        if: ${{ steps.metadata.outputs['update-type'] != 'version-update:semver-major' }}
        # v4.0.0
        uses: hmarr/auto-approve-action@f0939ea97e9205ef24d872e76833fa908a770363
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Checkout code
        # v4
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      # Set up a lightweight Python environment and install only the
      # dependencies required to run the unit tests.  This avoids the
      # heavier setup used in the main CI workflow which was causing
      # Dependabot update checks to fail.
      - name: Setup Python
        if: ${{ steps.metadata.outputs['package-ecosystem'] == 'pip' }}
        # v5
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'
      - name: Install dependencies
        if: ${{ steps.metadata.outputs['package-ecosystem'] == 'pip' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      # Run the unit tests against the Dependabot update.  Integration
      # tests are excluded here to keep the workflow fast; they run in
      # the main CI.  If any test fails this step will surface the
      # error and prevent automatic merging of the pull request.
      - name: Run unit tests
        if: ${{ steps.metadata.outputs['package-ecosystem'] == 'pip' }}
        run: pytest -m "not integration" -q

      - name: Enable auto-merge for Dependabot PRs
        if: >-
          ${{ steps.metadata.outputs['update-type'] !=
              'version-update:semver-major' }}
        # v3.0.0
        # yamllint disable-line rule:line-length
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
          token: ${{ secrets.GITHUB_TOKEN }}

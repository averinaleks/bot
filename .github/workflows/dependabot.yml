name: Dependabot Auto Merge

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    if: ${{ github.actor == 'dependabot[bot]' || github.event.pull_request.user.login == 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b # v2.4.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Auto approve
        uses: hmarr/auto-approve-action@f0939ea97e9205ef24d872e76833fa908a770363 # v4.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Checkout code
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      # Set up a Python environment that matches the main CI.  This
      # installs the appropriate Python version and device specific
      # dependencies (CPU by default) so that tests run in a
      # reproducible manner.  The setup-env action is defined in this
      # repository under .github/actions/setup-env.
      - name: Setup Python environment
        uses: ./.github/actions/setup-env
        with:
          python-version: '3.11'
          device: 'cpu'

      # Remove any stale pytest caches prior to running the test suite.
      # Old cache data can cause test runs to use outdated compiled
      # artifacts which in turn mask failures or lead to false
      # positives.  This action is defined locally under
      # .github/actions/clear-test-caches.
      - name: Remove test caches
        uses: ./.github/actions/clear-test-caches

      # Run the unit tests against the Dependabot update.  Integration
      # tests are excluded here to keep the workflow fast; they run in
      # the main CI.  If any test fails this step will surface the
      # error and prevent automatic merging of the pull request.
      - name: Run unit tests
        run: |
          set -o pipefail
          pytest -m "not integration" -o cache_dir=/mnt/pytest_cache -q

      - name: Enable auto-merge for Dependabot PRs
        if: steps.metadata.outputs.update-type != 'version-update:semver-major'
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3.0.0
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
          token: ${{ secrets.GITHUB_TOKEN }}


# Bandit is a security linter designed to find common security issues in Python code.
# This workflow runs Bandit on the codebase and uploads results to the Security tab.

name: Bandit

permissions:
  actions: read
  contents: read
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '38 16 * * 1'

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
      - name: Install Bandit
        run: pip install "bandit[sarif]"
      - name: Run Bandit
        id: run_bandit
        continue-on-error: true
        run: bandit -r . -ll -ii -x ./tests,./scripts,./gptoss_check -f sarif -o bandit.sarif
      - name: Check for SARIF results
        id: sarif_check
        run: |
          python - <<'PY'
          import json
          import os

          sarif_path = "bandit.sarif"
          upload = "false"

          if os.path.isfile(sarif_path) and os.path.getsize(sarif_path) > 0:
            try:
              with open(sarif_path, "r", encoding="utf-8") as sarif_file:
                sarif_data = json.load(sarif_file)
            except json.JSONDecodeError:
              upload = "false"
            else:
              if any(run.get("results") for run in sarif_data.get("runs", [])):
                upload = "true"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
            output.write(f"upload={upload}\n")
          PY
      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        if: steps.sarif_check.outputs.upload == 'true' && github.event_name != 'pull_request'
        with:
          sarif_file: bandit.sarif
      - name: Fail if Bandit failed
        if: ${{ steps.run_bandit.outcome == 'failure' }}
        run: exit 1


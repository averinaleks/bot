# Bandit is a security linter designed to find common security issues in Python code.
# This workflow runs Bandit on the codebase and uploads results to the Security tab.

name: Bandit

permissions:
  actions: read
  contents: read
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '38 16 * * 1'

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4
      - name: Set up Python
        uses: actions/setup-python@0a48b7bf1eabc3ec69474a3854c4f0a36e029be2 # v5
        with:
          python-version: '3.11'
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Install Bandit
        run: pip install bandit bandit-sarif-formatter
      - name: Run Bandit
        run: bandit -r . -ll -ii -x tests,scripts,gptoss_check -f sarif -o bandit.sarif --exit-zero
      - name: Check for SARIF results
        id: sarif_check
        run: |
          if [ -s bandit.sarif ] && [ "$(jq '[.runs[].results] | flatten | length' bandit.sarif)" -gt 0 ]; then
            echo "upload=true" >> "$GITHUB_OUTPUT"
          else
            echo "upload=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@ad2a4837011b42f6947b78d6417e7c253b1c504b # v3
        if: steps.sarif_check.outputs.upload == 'true' && github.event_name != 'pull_request'
        with:
          sarif_file: bandit.sarif


# Bandit is a security linter designed to find common security issues in Python code.
# This workflow runs Bandit on the codebase and uploads results to the Security tab.

name: Bandit

permissions:
  actions: read
  contents: read
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '38 16 * * 1'

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4
      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: '3.11'
      - name: Install Bandit
        run: pip install bandit bandit-sarif-formatter
      - name: Run Bandit
        id: run_bandit
        continue-on-error: true
        run: bandit -r . -ll -ii -x ./tests,./scripts,./gptoss_check -f sarif -o bandit.sarif
      - name: Check for SARIF results
        id: sarif_check
        run: |
          if [ -s bandit.sarif ] && [ "$(jq '[.runs[].results] | flatten | length' bandit.sarif)" -gt 0 ]; then
            echo "upload=true" >> "$GITHUB_OUTPUT"
          else
            echo "upload=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@64d10c13136e1c5bce3e5fbde8d4906eeaafc885 # v3.30.6
        if: steps.sarif_check.outputs.upload == 'true' && github.event_name != 'pull_request'
        with:
          sarif_file: bandit.sarif
      - name: Fail if Bandit failed
        if: ${{ steps.run_bandit.outcome == 'failure' }}
        run: exit 1


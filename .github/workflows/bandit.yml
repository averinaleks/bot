# Bandit is a security linter designed to find common security issues in Python code.
# This workflow runs Bandit on the codebase and uploads results to the Security tab.

name: Bandit

permissions:
  actions: read
  contents: read
  security-events: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '38 16 * * 1'

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.11'
      - name: Install Bandit
        run: |
          pip install "bandit[sarif]==1.9.2"
          # The "sarif" formatter is provided by a separate plugin which
          # is not automatically installed in some environments.
          pip install bandit-sarif-formatter==1.1.1
      - name: Run Bandit
        id: run_bandit
        continue-on-error: true
        run: bandit -r . -ll -ii -x ./tests,./scripts,./gptoss_check -f sarif -o bandit.sarif
      - name: Check for SARIF results
        id: sarif_check
        if: always()
        run: |
          python - <<'PY'
          import json
          import os

          sarif_path = "bandit.sarif"
          upload = "false"

          if os.path.isfile(sarif_path) and os.path.getsize(sarif_path) > 0:
            try:
              with open(sarif_path, "r", encoding="utf-8") as sarif_file:
                sarif_data = json.load(sarif_file)
            except json.JSONDecodeError:
              upload = "false"
            else:
              if any(run.get("results") for run in sarif_data.get("runs", [])):
                upload = "true"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
            output.write(f"upload={upload}\n")
          PY
      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        if: always() && steps.sarif_check.outputs.upload == 'true' && github.event_name != 'pull_request'
        with:
          sarif_file: bandit.sarif
      - name: Fail if Bandit found issues
        if: steps.sarif_check.outputs.upload == 'true'
        run: |
          echo "Bandit обнаружил проблемы безопасности. Ознакомьтесь с отчетом bandit.sarif."
          exit 1
      - name: Fail if Bandit failed
        if: steps.run_bandit.outcome == 'failure' && steps.sarif_check.outputs.upload != 'true'
        run: exit 1


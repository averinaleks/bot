---
name: trivy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "21 10 * * 2"

jobs:
  scan:
    name: Trivy filesystem scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    outputs:
      sarif: ${{ steps.summarize.outputs.sarif }}
      count: ${{ steps.summarize.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Define Trivy cache directory
        run: echo "TRIVY_CACHE_DIR=$RUNNER_TEMP/trivy-cache" >> "$GITHUB_ENV"

      - name: Prepare Trivy cache directory
        run: mkdir -p "${{ env.TRIVY_CACHE_DIR }}"

      - name: Cache Trivy vulnerability database
        id: cache-trivy
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: ${{ runner.os }}-trivy-db-${{ hashFiles('requirements*.txt', 'requirements*.in', 'Dockerfile*') }}
          restore-keys: |
            ${{ runner.os }}-trivy-db-

      - name: Run Trivy scan
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        env:
          TRIVY_FILE_PATTERNS: "pip:requirements.*\\.txt"
        with:
          scan-type: fs
          scanners: vuln,secret  # disable misconfig scans that crash on AWS policy bundle
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-results.sarif
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}

      - name: Summarize Trivy findings
        id: summarize
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f trivy-results.sarif ]; then
            printf '### Trivy scan summary\n\n* Отчёт Trivy не был создан.\n' >> "$GITHUB_STEP_SUMMARY"
            echo "sarif=false" >>"$GITHUB_OUTPUT"
            echo "count=0" >>"$GITHUB_OUTPUT"
            exit 0
          fi
          echo "sarif=true" >>"$GITHUB_OUTPUT"
          if ! count=$(python3 scripts/trivy_sarif_summary.py trivy-results.sarif); then
            echo "error: failed to summarize Trivy SARIF report" >&2
            exit 1
          fi
          # Guard against empty or non-numeric output so downstream conditions behave predictably.
          if ! [[ "$count" =~ ^[0-9]+$ ]]; then
            echo "error: unexpected count output '$count'" >&2
            exit 1
          fi
          printf '### Trivy scan summary\n\n* Найдено high/critical уязвимостей: `%s`\n' "$count" >> "$GITHUB_STEP_SUMMARY"
          echo "count=$count" >>"$GITHUB_OUTPUT"

      - name: Upload Trivy report artifact
        if: ${{ always() && steps.summarize.outputs.sarif == 'true' }}
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: trivy-results
          path: trivy-results.sarif

      - name: Fail workflow on Trivy execution error
        if: ${{ steps.trivy.outcome == 'failure' && steps.summarize.outputs.sarif != 'true' }}
        shell: bash
        run: |
          echo 'Trivy scan завершился с ошибкой и не создал SARIF отчёт.' >&2
          exit 1

  upload-sarif:
    name: Publish Trivy SARIF to Security tab
    needs: scan
    if: ${{ github.event_name != 'pull_request' && needs.scan.outputs.sarif == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Download Trivy report artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: trivy-results
          path: .

      - name: Upload Trivy SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@17783bfb99b07f70fae080b654aed0c514057477 # codeql-bundle-v2.23.3
        with:
          category: trivy-fs
          sarif_file: trivy-results.sarif

  fail-on-findings:
    name: Fail workflow on Trivy findings
    needs: scan
    if: ${{ github.event_name == 'pull_request' && needs.scan.outputs.sarif == 'true' && needs.scan.outputs.count != '0' }}
    runs-on: ubuntu-latest
    steps:
      - name: Fail on detected vulnerabilities
        shell: bash
        run: |
          echo "Обнаружено high/critical уязвимостей: ${{ needs.scan.outputs.count }}" >&2
          exit 1

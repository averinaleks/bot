---
name: trivy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "21 10 * * 2"

jobs:
  scan:
    name: Trivy filesystem scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        # v4.2.2

      - name: Define Trivy cache directory
        run: echo "TRIVY_CACHE_DIR=$RUNNER_TEMP/trivy-cache" >> "$GITHUB_ENV"

      - name: Prepare Trivy cache directory
        run: mkdir -p "${{ env.TRIVY_CACHE_DIR }}"

      - name: Cache Trivy vulnerability database
        id: cache-trivy
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/cache@v4.3.0
        # v4.3.0
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: ${{ runner.os }}-trivy-db-${{ hashFiles('requirements*.txt', 'requirements*.in', 'Dockerfile*') }}
          restore-keys: |
            ${{ runner.os }}-trivy-db-

      - name: Run Trivy scan
        id: trivy
        uses: aquasecurity/trivy-action@0.33.1
        continue-on-error: true
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-results.sarif
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}

      - name: Summarize Trivy findings
        id: summarize
        if: always()
        shell: bash
        run: |
          if [ ! -f trivy-results.sarif ]; then
            printf '### Trivy scan summary\n\n* Отчёт Trivy не был создан.\n' >> "$GITHUB_STEP_SUMMARY"
            echo "sarif=false" >>"$GITHUB_OUTPUT"
            echo "count=0" >>"$GITHUB_OUTPUT"
            exit 0
          fi
          echo "sarif=true" >>"$GITHUB_OUTPUT"
          count=$(python3 scripts/trivy_sarif_summary.py trivy-results.sarif)
          printf '### Trivy scan summary\n\n* Найдено high/critical уязвимостей: `%s`\n' "$count" >> "$GITHUB_STEP_SUMMARY"
          echo "count=$count" >>"$GITHUB_OUTPUT"

      - name: Upload Trivy SARIF to GitHub Security tab
        if: ${{ github.event_name != 'pull_request' && always() && steps.summarize.outputs.sarif == 'true' }}
        uses: github/codeql-action/upload-sarif@v3.30.6
        # v3.30.6
        with:
          category: trivy-fs
          sarif_file: trivy-results.sarif

      - name: Upload Trivy report artifact
        if: ${{ always() && steps.summarize.outputs.sarif == 'true' }}
        uses: actions/upload-artifact@v4.4.0
        # v4.4.0
        with:
          name: trivy-results
          path: trivy-results.sarif

      - name: Fail workflow on Trivy execution error
        if: ${{ steps.trivy.outcome == 'failure' && steps.summarize.outputs.sarif != 'true' }}
        shell: bash
        run: |
          echo 'Trivy scan завершился с ошибкой и не создал SARIF отчёт.' >&2
          exit 1

      - name: Fail workflow on Trivy findings
        if: ${{ steps.summarize.outputs.sarif == 'true' && steps.summarize.outputs.count != '0' }}
        shell: bash
        run: |
          echo "Обнаружено high/critical уязвимостей: ${{ steps.summarize.outputs.count }}" >&2
          exit 1

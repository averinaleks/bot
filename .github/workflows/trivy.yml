---
name: trivy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "21 10 * * 2"

jobs:
  scan:
    name: Trivy filesystem scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@2d1e4ee8c7c0e8a6c5a0f1f3af3c1b19aa9c9329
        # v4.2.2

      - name: Define Trivy cache directory
        run: echo "TRIVY_CACHE_DIR=$RUNNER_TEMP/trivy-cache" >> "$GITHUB_ENV"

      - name: Prepare Trivy cache directory
        run: mkdir -p "${{ env.TRIVY_CACHE_DIR }}"

      - name: Cache Trivy vulnerability database
        id: cache-trivy
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        # v4.3.0
        with:
          path: ${{ env.TRIVY_CACHE_DIR }}
          key: ${{ runner.os }}-trivy-db-${{ hashFiles('requirements*.txt', 'requirements*.in', 'Dockerfile*') }}
          restore-keys: |
            ${{ runner.os }}-trivy-db-

      - name: Run Trivy scan
        id: trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          format: sarif
          output: trivy-results.sarif
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}

      - name: Summarize Trivy findings
        id: summarize
        if: always()
        shell: bash
        run: |
          if [ ! -f trivy-results.sarif ]; then
            printf '### Trivy scan summary\n\n* Отчёт Trivy не был создан.\n' >> "$GITHUB_STEP_SUMMARY"
            echo "sarif=false" >>"$GITHUB_OUTPUT"
            exit 0
          fi
          echo "sarif=true" >>"$GITHUB_OUTPUT"
          count=$(python3 scripts/trivy_sarif_summary.py trivy-results.sarif)
          printf '### Trivy scan summary\n\n* Найдено high/critical уязвимостей: `%s`\n' "$count" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Trivy SARIF to GitHub Security tab
        if: ${{ github.event_name != 'pull_request' && always() && steps.summarize.outputs.sarif == 'true' }}
        uses: github/codeql-action/upload-sarif@64d10c13136e1c5bce3e5fbde8d4906eeaafc885
        # v3.30.6
        with:
          category: trivy-fs
          sarif_file: trivy-results.sarif

      - name: Upload Trivy report artifact
        if: ${{ always() && steps.summarize.outputs.sarif == 'true' }}
        uses: actions/upload-artifact@604f733a2e36051e8c3ab8bb4ff7f266622f8dba
        # v4.4.0
        with:
          name: trivy-results
          path: trivy-results.sarif

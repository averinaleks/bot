FROM python:3.12-slim AS builder

# Устанавливаем зависимости для сборки и выполнения
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git cmake ninja-build \
    libtbbmalloc2 curl \
    libnuma-dev \
    && rm -rf /var/lib/apt/lists/*

ENV PYTHONUNBUFFERED=1 HF_HOME=/workspace/hf-cache
ENV VLLM_TARGET_DEVICE=cpu

RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir openai==1.99.1 && \
    pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cpu vllm==0.10.0

FROM python:3.12-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    libtbbmalloc2 curl \
    libnuma-dev \
    && rm -rf /var/lib/apt/lists/*

ENV PYTHONUNBUFFERED=1 HF_HOME=/workspace/hf-cache
ENV VLLM_TARGET_DEVICE=cpu
ENV PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cpu

COPY --from=builder /usr/local /usr/local

EXPOSE 8000

CMD python -m vllm.entrypoints.openai.api_server --host 0.0.0.0 --port 8000 --model ${MODEL:-openai/gpt-oss-20b} --device cpu --max-num-seqs 4 --enforce-eager --disable-async-output-proc

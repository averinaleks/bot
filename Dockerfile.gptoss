# Python 3.12 slim already ships with patched setuptools (>=80.9.0), eliminating
# CVE-2024-6345 / CVE-2025-47273 flagged by Trivy в предыдущем Python 3.11
# образе. pip>=25.3 уже включает проверку симлинков (CVE-2025-8869), поэтому
# дополнительных модификаций исходников pip не требуется.
FROM python:3.12-slim

ENV PYTHONUNBUFFERED=1 HF_HOME=/workspace/hf-cache
ENV VLLM_DEVICE=cpu VLLM_LOGGING_LEVEL=DEBUG

RUN apt-get update \
    && apt-get install -y --no-install-recommends curl \
    && python -m ensurepip --upgrade \
    && python -m pip install --no-cache-dir 'pip>=25.3' 'setuptools>=80.9.0,<81' wheel \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd --system bot \
    && useradd --system --gid bot --home-dir /home/bot --shell /bin/bash bot \
    && mkdir -p /home/bot \
    && chown -R bot:bot /home/bot

# Для mock-сервера не нужны зависимости проекта: он использует только stdlib.
# Установка полного requirements.txt в Python 3.12 часто падает из‑за
# отсутствующих колёс, поэтому оставляем образ максимально лёгким.

COPY scripts/gptoss_mock_server.py /usr/local/bin/gptoss_mock_server.py
RUN chown bot:bot /usr/local/bin/gptoss_mock_server.py

USER bot

EXPOSE 8000

CMD ["python", "/usr/local/bin/gptoss_mock_server.py", "--host", "0.0.0.0", "--port", "8000"]


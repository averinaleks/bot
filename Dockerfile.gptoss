# Python 3.12 slim already ships with patched setuptools (>=80.9.0),
# eliminating CVE-2024-6345 / CVE-2025-47273 flagged by Trivy in the
# previous Python 3.11 base image.
FROM python:3.12-slim

ENV PYTHONUNBUFFERED=1 HF_HOME=/workspace/hf-cache
ENV VLLM_DEVICE=cpu VLLM_LOGGING_LEVEL=DEBUG

RUN apt-get update \
    && apt-get install -y --no-install-recommends curl \
    && python -m ensurepip --upgrade \
    && python -m pip install --no-cache-dir 'pip>=24.0' 'setuptools>=80.9.0,<81' wheel \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd --system bot \
    && useradd --system --gid bot --home-dir /home/bot --shell /bin/bash bot \
    && mkdir -p /home/bot \
    && chown -R bot:bot /home/bot

COPY scripts/gptoss_mock_server.py /usr/local/bin/gptoss_mock_server.py
RUN chown bot:bot /usr/local/bin/gptoss_mock_server.py

USER bot

EXPOSE 8000

CMD ["python", "/usr/local/bin/gptoss_mock_server.py", "--host", "0.0.0.0", "--port", "8000"]



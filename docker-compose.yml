services:
  trading_bot:
    build:
      context: .
      dockerfile: Dockerfile
    image: trading_bot-trading-bot:latest
    container_name: trading_bot
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - PYTHONUNBUFFERED=1
      - API_KEY=${API_KEY}
      - API_SECRET=${API_SECRET}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - CHAT_ID=${CHAT_ID}
      - CACHE_DIR=/app/cache
      - LOG_DIR=/app/logs
      - CONFIG_PATH=/app/config.json
    volumes:
      - ./logs:/app/logs
      - ./models:/app/models
      - ./cache:/app/cache
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 16G
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']  # Удален параметр count
              capabilities: [gpu]
    networks:
      - trading_bot_default
    stdin_open: true
    tty: true
    restart: unless-stopped
    shm_size: '8gb'
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "python3.12", "-c", "import psutil; exit(0 if psutil.cpu_percent() < 90 else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
networks:
  trading_bot_default:
    driver: bridge